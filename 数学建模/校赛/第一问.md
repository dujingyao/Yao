# 颜色空间转换数学模型详解

## 1. 问题背景与数学建模

### 1.1 问题描述
将BT2020高清视频源的颜色空间转换到普通显示屏RGB颜色空间，使得颜色转换损失最小。

### 1.2 数学抽象
- **源色域**：$S = \{(x,y) \in \mathbb{R}^2 | (x,y) \in \triangle_{BT2020}\}$
- **目标色域**：$D = \{(x,y) \in \mathbb{R}^2 | (x,y) \in \triangle_{Display}\}$
- **映射函数**：$f: S \rightarrow D$
- **优化目标**：$\min_{f} \mathcal{L}(f)$

## 2. 核心数学模型

### 2.1 色域表示模型

#### CIE 1931 xy色度坐标系
任意颜色在CIE 1931标准中可表示为：
$$C = (x, y, Y)$$
其中：
- $x, y$：色度坐标
- $Y$：亮度分量
- 约束条件：$x + y + z = 1$，$z = 1 - x - y$

#### 三角形色域定义
色域三角形由三个顶点定义：
$$\triangle = \{V_R, V_G, V_B\}$$

BT2020标准：
$$V_{BT2020} = \begin{bmatrix}
0.708 & 0.292 \\
0.170 & 0.797 \\
0.131 & 0.046
\end{bmatrix}$$

普通显示屏：
$$V_{Display} = \begin{bmatrix}
0.640 & 0.330 \\
0.300 & 0.600 \\
0.150 & 0.060
\end{bmatrix}$$

### 2.2 重心坐标映射模型

#### 重心坐标计算
对于三角形$\triangle = \{V_1, V_2, V_3\}$内的点$P = (x, y)$，其重心坐标$(\alpha, \beta, \gamma)$满足：

$$P = \alpha V_1 + \beta V_2 + \gamma V_3$$
$$\alpha + \beta + \gamma = 1$$

具体计算公式：
$$\alpha = \frac{(y_2 - y_3)(x - x_3) + (x_3 - x_2)(y - y_3)}{(y_2 - y_3)(x_1 - x_3) + (x_3 - x_2)(y_1 - y_3)}$$

$$\beta = \frac{(y_3 - y_1)(x - x_3) + (x_1 - x_3)(y - y_3)}{(y_2 - y_3)(x_1 - x_3) + (x_3 - x_2)(y_1 - y_3)}$$

$$\gamma = 1 - \alpha - \beta$$

#### 映射函数
$$f: P_{source} \rightarrow P_{target}$$
$$P_{target} = \alpha V_{target,1} + \beta V_{target,2} + \gamma V_{target,3}$$

其中$(\alpha, \beta, \gamma)$为$P_{source}$在源三角形中的重心坐标。

### 2.3 点在三角形判定模型

使用符号函数方法：
$$sign(P_1, P_2, P_3) = (P_1.x - P_3.x)(P_2.y - P_3.y) - (P_2.x - P_3.x)(P_1.y - P_3.y)$$

点$P$在三角形内当且仅当：
$$d_1 = sign(P, V_1, V_2)$$
$$d_2 = sign(P, V_2, V_3)$$
$$d_3 = sign(P, V_3, V_1)$$

满足：$\neg((d_1 < 0) \lor (d_2 < 0) \lor (d_3 < 0)) \land ((d_1 > 0) \lor (d_2 > 0) \lor (d_3 > 0))$

### 2.4 色域外点投影模型

#### 点到线段投影
对于线段$\overline{AB}$和点$P$，投影点$P'$计算：

$$\vec{v} = B - A$$
$$\vec{u} = P - A$$
$$t = \frac{\vec{u} \cdot \vec{v}}{|\vec{v}|^2}$$
$$t_{clamp} = \max(0, \min(1, t))$$
$$P' = A + t_{clamp} \cdot \vec{v}$$

#### 最近边投影
$$P_{projected} = \arg\min_{P' \in \partial\triangle} ||P - P'||_2$$

其中$\partial\triangle$表示三角形边界。

## 3. 损失函数模型

### 3.1 欧氏距离损失
$$\mathcal{L}_{Euclidean} = \frac{1}{N} \sum_{i=1}^N ||P_{source,i} - f(P_{source,i})||_2^2$$

### 3.2 感知损失（CIE ΔE）
$$\mathcal{L}_{Perceptual} = \frac{1}{N} \sum_{i=1}^N \Delta E(P_{source,i}, f(P_{source,i}))$$

其中$\Delta E$为CIE色差公式：
$$\Delta E_{ab}^* = \sqrt{(\Delta L^*)^2 + (\Delta a^*)^2 + (\Delta b^*)^2}$$

### 3.3 加权损失函数
$$\mathcal{L}_{weighted} = \frac{1}{N} \sum_{i=1}^N w_i \cdot ||P_{source,i} - f(P_{source,i})||_2^2$$

权重$w_i$可根据颜色重要性设定。

## 4. 优化模型

### 4.1 约束优化问题
$$\begin{aligned}
\min_{f} \quad & \mathcal{L}(f) \\
\text{s.t.} \quad & f(P) \in D, \quad \forall P \in S \\
& f \text{ 连续且单调}
\end{aligned}$$

### 4.2 色域覆盖率
$$\eta = \frac{Area(D)}{Area(S)} = \frac{Area(\triangle_{Display})}{Area(\triangle_{BT2020})}$$

三角形面积计算：
$$Area(\triangle) = \frac{1}{2}|x_1(y_2 - y_3) + x_2(y_3 - y_1) + x_3(y_1 - y_2)|$$

## 5. 算法复杂度分析

### 5.1 时间复杂度
- 重心坐标计算：$O(1)$
- 点在三角形判定：$O(1)$
- 投影计算：$O(1)$
- 总体映射：$O(N)$，其中$N$为像素数

### 5.2 空间复杂度
- 存储源图像：$O(N)$
- 存储映射结果：$O(N)$
- 辅助数据结构：$O(1)$

## 6. 模型验证指标

### 6.1 色差指标
- **平均色差**：$\bar{\Delta E} = \frac{1}{N}\sum_{i=1}^N \Delta E_i$
- **最大色差**：$\Delta E_{max} = \max_i \Delta E_i$
- **色差标准差**：$\sigma_{\Delta E} = \sqrt{\frac{1}{N}\sum_{i=1}^N (\Delta E_i - \bar{\Delta E})^2}$

### 6.2 几何保真度
- **面积保持率**：$\rho_{area} = \frac{Area(f(S))}{Area(S)}$
- **形状失真度**：基于Hausdorff距离计算

### 6.3 感知质量
- **色域利用率**：映射后颜色在目标色域中的分布均匀性
- **色彩饱和度保持**：关键颜色（如肤色、天空色）的饱和度变化

## 7. 模型扩展

### 7.1 非线性映射
$$f(P) = \sum_{j=1}^M w_j \phi_j(P)$$
其中$\phi_j$为基函数（如径向基函数、多项式基等）。

### 7.2 自适应映射
根据图像内容动态调整映射参数：
$$f_{\text{adaptive}}(P) = f_{\text{base}}(P) + \Delta f(P, \text{context})$$

### 7.3 多目标优化
$$\min_{f} [\mathcal{L}_1(f), \mathcal{L}_2(f), \ldots, \mathcal{L}_k(f)]$$
使用Pareto最优解处理色差、对比度、饱和度等多个目标。

## 8. 实现要点

### 8.1 数值稳定性
- 处理除零情况：$\text{denom} < \epsilon$时的特殊处理
- 浮点精度控制：使用合适的容差$\epsilon = 10^{-10}$

### 8.2 边界处理
- 色域边界的平滑处理
- 映射不连续性的消除

### 8.3 性能优化
- 向量化计算：利用NumPy广播特性
- 并行处理：大图像的分块处理
- 查找表：预计算常用映射

---

## 总结

本模型通过重心坐标映射实现了从BT2020色域到普通显示屏色域的最优转换，主要特点：

1. **几何保真**：保持三角形内点的相对位置关系
2. **连续性**：确保映射函数的连续性
3. **最优性**：最小化感知色差损失
4. **实用性**：计算复杂度低，适合实时应用

该模型为后续的多通道色域转换（问题2）和LED显示器校正（问题3）奠定了理论基础。