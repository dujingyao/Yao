#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
é—®é¢˜2ï¼šå¯¹é™„ä»¶2ä¸­302å®¶æ— ä¿¡è´·è®°å½•ä¼ä¸šçš„ä¿¡è´·é£é™©è¿›è¡Œé‡åŒ–åˆ†æ
ç­–ç•¥ï¼šå®Œå…¨åŸºäºå‘ç¥¨æ•°æ®æ„å»ºé£é™©è¯„ä¼°æ¨¡å‹
ç›®æ ‡ï¼šåœ¨1äº¿å…ƒé¢åº¦å†…åˆ¶å®šæœ€ä¼˜ä¿¡è´·æ–¹æ¡ˆ
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import os
import warnings
warnings.filterwarnings('ignore')

# è®¾ç½®ä¸­æ–‡æ˜¾ç¤º
plt.rcParams['font.sans-serif'] = ['SimHei']
plt.rcParams['axes.unicode_minus'] = False

class CreditAnalyzer:
    """æ— ä¿¡è´·è®°å½•ä¼ä¸šçš„ä¿¡è´·é£é™©åˆ†æå™¨"""
    
    def __init__(self):
        """åˆå§‹åŒ–åˆ†æå™¨"""
        self.ä¼ä¸šä¿¡æ¯ = None
        self.è¿›é¡¹å‘ç¥¨ = None
        self.é”€é¡¹å‘ç¥¨ = None
        self.å®¢æˆ·æµå¤±ç‡æ•°æ® = None
        self.ç»¼åˆæ•°æ® = None
        
        # é£é™©è¯„åˆ†ç»´åº¦æƒé‡
        self.æƒé‡_è´¢åŠ¡çŠ¶å†µ = 0.40  # é‡ç‚¹å…³æ³¨ç°é‡‘æµå’Œç›ˆåˆ©èƒ½åŠ›
        self.æƒé‡_ä¸šåŠ¡ç¨³å®š = 0.35  # å…³æ³¨ç»è¥æŒç»­æ€§
        self.æƒé‡_å‘ç¥¨è´¨é‡ = 0.25  # å…³æ³¨äº¤æ˜“çœŸå®æ€§
        
    def load_data(self):
        """åŠ è½½æ•°æ®"""
        try:
            print("ğŸ“Š åŠ è½½æ•°æ®...")
            # è¯»å–ä¼ä¸šä¿¡æ¯
            self.ä¼ä¸šä¿¡æ¯ = pd.read_excel('é™„ä»¶2ï¼š302å®¶æ— ä¿¡è´·è®°å½•ä¼ä¸šçš„ç›¸å…³æ•°æ®.xlsx', 
                                     sheet_name='ä¼ä¸šä¿¡æ¯')
            
            # è¯»å–å‘ç¥¨ä¿¡æ¯
            self.è¿›é¡¹å‘ç¥¨ = pd.read_excel('é™„ä»¶2ï¼š302å®¶æ— ä¿¡è´·è®°å½•ä¼ä¸šçš„ç›¸å…³æ•°æ®.xlsx', 
                                     sheet_name='è¿›é¡¹å‘ç¥¨ä¿¡æ¯')
            self.é”€é¡¹å‘ç¥¨ = pd.read_excel('é™„ä»¶2ï¼š302å®¶æ— ä¿¡è´·è®°å½•ä¼ä¸šçš„ç›¸å…³æ•°æ®.xlsx', 
                                     sheet_name='é”€é¡¹å‘ç¥¨ä¿¡æ¯')
            
            # è¯»å–å®¢æˆ·æµå¤±ç‡æ•°æ®
            self.å®¢æˆ·æµå¤±ç‡æ•°æ® = pd.read_excel('é™„ä»¶3ï¼šé“¶è¡Œè´·æ¬¾å¹´åˆ©ç‡ä¸å®¢æˆ·æµå¤±ç‡å…³ç³»çš„ç»Ÿè®¡æ•°æ®.xlsx')
            
            print(f"âœ… æ•°æ®åŠ è½½å®Œæˆ:")
            print(f"   - ä¼ä¸šæ€»æ•°: {len(self.ä¼ä¸šä¿¡æ¯)}å®¶")
            print(f"   - è¿›é¡¹å‘ç¥¨: {len(self.è¿›é¡¹å‘ç¥¨)}æ¡")
            print(f"   - é”€é¡¹å‘ç¥¨: {len(self.é”€é¡¹å‘ç¥¨)}æ¡")
            
            return True
            
        except Exception as e:
            print(f"âŒ æ•°æ®åŠ è½½å¤±è´¥: {str(e)}")
            return False
    
    def analyze_invoice_features(self):
        """åˆ†æå‘ç¥¨ç‰¹å¾"""
        print("\nğŸ” å¼€å§‹åˆ†æå‘ç¥¨æ•°æ®...")
        
        # 1. åˆå§‹åŒ–æ•°æ®æ¡†
        self.ç»¼åˆæ•°æ® = self.ä¼ä¸šä¿¡æ¯.copy()
        
        # 2. åˆ†æé”€é¡¹å‘ç¥¨
        é”€é¡¹ç‰¹å¾ = self._analyze_sales_invoices()
        self.ç»¼åˆæ•°æ® = self.ç»¼åˆæ•°æ®.merge(é”€é¡¹ç‰¹å¾, on='ä¼ä¸šä»£å·', how='left')
        
        # 3. åˆ†æè¿›é¡¹å‘ç¥¨
        è¿›é¡¹ç‰¹å¾ = self._analyze_purchase_invoices()
        self.ç»¼åˆæ•°æ® = self.ç»¼åˆæ•°æ®.merge(è¿›é¡¹ç‰¹å¾, on='ä¼ä¸šä»£å·', how='left')
        
        # 4. è®¡ç®—ç»¼åˆæŒ‡æ ‡
        self._calculate_financial_metrics()
        self._calculate_business_stability()
        self._calculate_invoice_quality()
        
        print("âœ… å‘ç¥¨åˆ†æå®Œæˆ")
        
    def _analyze_sales_invoices(self):
        """åˆ†æé”€é¡¹å‘ç¥¨"""
        # åˆ›å»ºç»“æœDataFrame
        é”€é¡¹ç‰¹å¾ = pd.DataFrame()
        é”€é¡¹ç‰¹å¾['ä¼ä¸šä»£å·'] = self.ä¼ä¸šä¿¡æ¯['ä¼ä¸šä»£å·'].unique()
        
        # 1. è®¡ç®—æ”¶å…¥æŒ‡æ ‡
        æœ‰æ•ˆå‘ç¥¨ = self.é”€é¡¹å‘ç¥¨[self.é”€é¡¹å‘ç¥¨['å‘ç¥¨çŠ¶æ€'] == 'æœ‰æ•ˆå‘ç¥¨']
        æ”¶å…¥ç»Ÿè®¡ = æœ‰æ•ˆå‘ç¥¨.groupby('ä¼ä¸šä»£å·').agg({
            'é‡‘é¢': ['sum', 'mean', 'std', 'count']
        }).fillna(0)
        æ”¶å…¥ç»Ÿè®¡.columns = ['å¹´æ”¶å…¥', 'å¹³å‡æ”¶å…¥', 'æ”¶å…¥æ³¢åŠ¨', 'æ”¶å…¥ç¬”æ•°']
        é”€é¡¹ç‰¹å¾ = é”€é¡¹ç‰¹å¾.merge(æ”¶å…¥ç»Ÿè®¡, on='ä¼ä¸šä»£å·', how='left')
        
        # 2. è®¡ç®—ä½œåºŸå’Œè´Ÿæ•°å‘ç¥¨æ¯”ä¾‹
        å‘ç¥¨çŠ¶æ€ = self.é”€é¡¹å‘ç¥¨.groupby('ä¼ä¸šä»£å·')['å‘ç¥¨çŠ¶æ€'].value_counts().unstack(fill_value=0)
        æ€»å‘ç¥¨æ•° = å‘ç¥¨çŠ¶æ€.sum(axis=1)
        é”€é¡¹ç‰¹å¾['é”€é¡¹ä½œåºŸç‡'] = å‘ç¥¨çŠ¶æ€['ä½œåºŸå‘ç¥¨'] / æ€»å‘ç¥¨æ•°
        é”€é¡¹ç‰¹å¾['é”€é¡¹è´Ÿæ•°ç‡'] = å‘ç¥¨çŠ¶æ€['è´Ÿæ•°å‘ç¥¨'] / æ€»å‘ç¥¨æ•°
        
        # 3. è®¡ç®—å®¢æˆ·é›†ä¸­åº¦
        å®¢æˆ·ç»Ÿè®¡ = æœ‰æ•ˆå‘ç¥¨.groupby('ä¼ä¸šä»£å·').agg({
            'è´­æ–¹å•ä½ä»£å·': lambda x: len(set(x)),  # ä¸åŒå®¢æˆ·æ•°
            'é‡‘é¢': lambda x: (x / x.sum() ** 2).sum()  # HHIæŒ‡æ•°
        })
        å®¢æˆ·ç»Ÿè®¡.columns = ['å®¢æˆ·æ•°é‡', 'å®¢æˆ·é›†ä¸­åº¦']
        é”€é¡¹ç‰¹å¾ = é”€é¡¹ç‰¹å¾.merge(å®¢æˆ·ç»Ÿè®¡, on='ä¼ä¸šä»£å·', how='left')
        
        return é”€é¡¹ç‰¹å¾

    def _analyze_purchase_invoices(self):
        """åˆ†æè¿›é¡¹å‘ç¥¨"""
        # åˆ›å»ºç»“æœDataFrame
        è¿›é¡¹ç‰¹å¾ = pd.DataFrame()
        è¿›é¡¹ç‰¹å¾['ä¼ä¸šä»£å·'] = self.ä¼ä¸šä¿¡æ¯['ä¼ä¸šä»£å·'].unique()
        
        # 1. è®¡ç®—æˆæœ¬æŒ‡æ ‡
        æœ‰æ•ˆå‘ç¥¨ = self.è¿›é¡¹å‘ç¥¨[self.è¿›é¡¹å‘ç¥¨['å‘ç¥¨çŠ¶æ€'] == 'æœ‰æ•ˆå‘ç¥¨']
        æˆæœ¬ç»Ÿè®¡ = æœ‰æ•ˆå‘ç¥¨.groupby('ä¼ä¸šä»£å·').agg({
            'é‡‘é¢': ['sum', 'mean', 'std', 'count']
        }).fillna(0)
        æˆæœ¬ç»Ÿè®¡.columns = ['å¹´é‡‡è´­é¢', 'å¹³å‡é‡‡è´­', 'é‡‡è´­æ³¢åŠ¨', 'é‡‡è´­ç¬”æ•°']
        è¿›é¡¹ç‰¹å¾ = è¿›é¡¹ç‰¹å¾.merge(æˆæœ¬ç»Ÿè®¡, on='ä¼ä¸šä»£å·', how='left')
        
        # 2. è®¡ç®—ä½œåºŸå’Œè´Ÿæ•°å‘ç¥¨æ¯”ä¾‹
        å‘ç¥¨çŠ¶æ€ = self.è¿›é¡¹å‘ç¥¨.groupby('ä¼ä¸šä»£å·')['å‘ç¥¨çŠ¶æ€'].value_counts().unstack(fill_value=0)
        æ€»å‘ç¥¨æ•° = å‘ç¥¨çŠ¶æ€.sum(axis=1)
        è¿›é¡¹ç‰¹å¾['è¿›é¡¹ä½œåºŸç‡'] = å‘ç¥¨çŠ¶æ€['ä½œåºŸå‘ç¥¨'] / æ€»å‘ç¥¨æ•°
        è¿›é¡¹ç‰¹å¾['è¿›é¡¹è´Ÿæ•°ç‡'] = å‘ç¥¨çŠ¶æ€['è´Ÿæ•°å‘ç¥¨'] / æ€»å‘ç¥¨æ•°
        
        # 3. è®¡ç®—ä¾›åº”å•†é›†ä¸­åº¦
        ä¾›åº”å•†ç»Ÿè®¡ = æœ‰æ•ˆå‘ç¥¨.groupby('ä¼ä¸šä»£å·').agg({
            'é”€æ–¹å•ä½ä»£å·': lambda x: len(set(x)),  # ä¸åŒä¾›åº”å•†æ•°
            'é‡‘é¢': lambda x: (x / x.sum() ** 2).sum()  # HHIæŒ‡æ•°
        })
        ä¾›åº”å•†ç»Ÿè®¡.columns = ['ä¾›åº”å•†æ•°é‡', 'ä¾›åº”å•†é›†ä¸­åº¦']
        è¿›é¡¹ç‰¹å¾ = è¿›é¡¹ç‰¹å¾.merge(ä¾›åº”å•†ç»Ÿè®¡, on='ä¼ä¸šä»£å·', how='left')
        
        return è¿›é¡¹ç‰¹å¾

    def _calculate_financial_metrics(self):
        """è®¡ç®—è´¢åŠ¡æŒ‡æ ‡"""
        # 1. è®¡ç®—æ¯›åˆ©ç‡
        self.ç»¼åˆæ•°æ®['æ¯›åˆ©ç‡'] = (self.ç»¼åˆæ•°æ®['å¹´æ”¶å…¥'] - self.ç»¼åˆæ•°æ®['å¹´é‡‡è´­é¢']) / self.ç»¼åˆæ•°æ®['å¹´æ”¶å…¥']
        self.ç»¼åˆæ•°æ®['æ¯›åˆ©ç‡'] = self.ç»¼åˆæ•°æ®['æ¯›åˆ©ç‡'].fillna(0).clip(-1, 1)
        
        # 2. è®¡ç®—æ”¶å…¥æˆæœ¬æ¯”
        self.ç»¼åˆæ•°æ®['æ”¶å…¥æˆæœ¬æ¯”'] = self.ç»¼åˆæ•°æ®['å¹´æ”¶å…¥'] / self.ç»¼åˆæ•°æ®['å¹´é‡‡è´­é¢']
        self.ç»¼åˆæ•°æ®['æ”¶å…¥æˆæœ¬æ¯”'] = self.ç»¼åˆæ•°æ®['æ”¶å…¥æˆæœ¬æ¯”'].fillna(0).clip(0, 10)
        
        # 3. è®¡ç®—ç°é‡‘æµç¨³å®šæ€§
        self.ç»¼åˆæ•°æ®['æ”¶å…¥ç¨³å®šæ€§'] = 1 - (self.ç»¼åˆæ•°æ®['æ”¶å…¥æ³¢åŠ¨'] / self.ç»¼åˆæ•°æ®['å¹³å‡æ”¶å…¥']).fillna(1)
        self.ç»¼åˆæ•°æ®['é‡‡è´­ç¨³å®šæ€§'] = 1 - (self.ç»¼åˆæ•°æ®['é‡‡è´­æ³¢åŠ¨'] / self.ç»¼åˆæ•°æ®['å¹³å‡é‡‡è´­']).fillna(1)
        
        # 4. è®¡ç®—è´¢åŠ¡çŠ¶å†µè¯„åˆ†
        self.ç»¼åˆæ•°æ®['è´¢åŠ¡çŠ¶å†µè¯„åˆ†'] = (
            self.ç»¼åˆæ•°æ®['æ¯›åˆ©ç‡'].clip(0, 1) * 0.4 +
            self.ç»¼åˆæ•°æ®['æ”¶å…¥ç¨³å®šæ€§'].clip(0, 1) * 0.3 +
            self.ç»¼åˆæ•°æ®['é‡‡è´­ç¨³å®šæ€§'].clip(0, 1) * 0.3
        ).clip(0, 1)
        
    def _calculate_business_stability(self):
        """è®¡ç®—ä¸šåŠ¡ç¨³å®šæ€§"""
        # 1. è®¡ç®—ç»è¥è§„æ¨¡å¾—åˆ†
        self.ç»¼åˆæ•°æ®['æ”¶å…¥è§„æ¨¡å¾—åˆ†'] = self.ç»¼åˆæ•°æ®['å¹´æ”¶å…¥'] / self.ç»¼åˆæ•°æ®['å¹´æ”¶å…¥'].max()
        self.ç»¼åˆæ•°æ®['é‡‡è´­è§„æ¨¡å¾—åˆ†'] = self.ç»¼åˆæ•°æ®['å¹´é‡‡è´­é¢'] / self.ç»¼åˆæ•°æ®['å¹´é‡‡è´­é¢'].max()
        
        # 2. è®¡ç®—äº¤æ˜“é¢‘æ¬¡å¾—åˆ†
        self.ç»¼åˆæ•°æ®['æ”¶å…¥é¢‘æ¬¡å¾—åˆ†'] = self.ç»¼åˆæ•°æ®['æ”¶å…¥ç¬”æ•°'] / self.ç»¼åˆæ•°æ®['æ”¶å…¥ç¬”æ•°'].max()
        self.ç»¼åˆæ•°æ®['é‡‡è´­é¢‘æ¬¡å¾—åˆ†'] = self.ç»¼åˆæ•°æ®['é‡‡è´­ç¬”æ•°'] / self.ç»¼åˆæ•°æ®['é‡‡è´­ç¬”æ•°'].max()
        
        # 3. è®¡ç®—å®¢æˆ·ä¾›åº”å•†å¤šæ ·æ€§
        self.ç»¼åˆæ•°æ®['å®¢æˆ·å¤šæ ·æ€§'] = 1 - self.ç»¼åˆæ•°æ®['å®¢æˆ·é›†ä¸­åº¦']
        self.ç»¼åˆæ•°æ®['ä¾›åº”å•†å¤šæ ·æ€§'] = 1 - self.ç»¼åˆæ•°æ®['ä¾›åº”å•†é›†ä¸­åº¦']
        
        # 4. è®¡ç®—ä¸šåŠ¡ç¨³å®šæ€§è¯„åˆ†
        self.ç»¼åˆæ•°æ®['ä¸šåŠ¡ç¨³å®šæ€§è¯„åˆ†'] = (
            self.ç»¼åˆæ•°æ®['æ”¶å…¥è§„æ¨¡å¾—åˆ†'] * 0.2 +
            self.ç»¼åˆæ•°æ®['é‡‡è´­è§„æ¨¡å¾—åˆ†'] * 0.2 +
            self.ç»¼åˆæ•°æ®['æ”¶å…¥é¢‘æ¬¡å¾—åˆ†'] * 0.15 +
            self.ç»¼åˆæ•°æ®['é‡‡è´­é¢‘æ¬¡å¾—åˆ†'] * 0.15 +
            self.ç»¼åˆæ•°æ®['å®¢æˆ·å¤šæ ·æ€§'] * 0.15 +
            self.ç»¼åˆæ•°æ®['ä¾›åº”å•†å¤šæ ·æ€§'] * 0.15
        ).clip(0, 1)
        
    def _calculate_invoice_quality(self):
        """è®¡ç®—å‘ç¥¨è´¨é‡"""
        # 1. è®¡ç®—æ•´ä½“ä½œåºŸç‡
        self.ç»¼åˆæ•°æ®['æ•´ä½“ä½œåºŸç‡'] = (
            self.ç»¼åˆæ•°æ®['é”€é¡¹ä½œåºŸç‡'] * 0.5 + 
            self.ç»¼åˆæ•°æ®['è¿›é¡¹ä½œåºŸç‡'] * 0.5
        )
        
        # 2. è®¡ç®—æ•´ä½“è´Ÿæ•°å‘ç¥¨ç‡
        self.ç»¼åˆæ•°æ®['æ•´ä½“è´Ÿæ•°ç‡'] = (
            self.ç»¼åˆæ•°æ®['é”€é¡¹è´Ÿæ•°ç‡'] * 0.5 + 
            self.ç»¼åˆæ•°æ®['è¿›é¡¹è´Ÿæ•°ç‡'] * 0.5
        )
        
        # 3. è®¡ç®—å‘ç¥¨è´¨é‡è¯„åˆ†
        self.ç»¼åˆæ•°æ®['å‘ç¥¨è´¨é‡è¯„åˆ†'] = (
            (1 - self.ç»¼åˆæ•°æ®['æ•´ä½“ä½œåºŸç‡']) * 0.6 +
            (1 - self.ç»¼åˆæ•°æ®['æ•´ä½“è´Ÿæ•°ç‡']) * 0.4
        ).clip(0, 1)
        
    def build_risk_model(self):
        """æ„å»ºé£é™©è¯„ä¼°æ¨¡å‹"""
        print("\nğŸ§® æ„å»ºé£é™©è¯„ä¼°æ¨¡å‹...")
        
        # 1. è®¡ç®—ç»¼åˆé£é™©è¯„åˆ†
        self.ç»¼åˆæ•°æ®['ç»¼åˆé£é™©è¯„åˆ†'] = (
            self.ç»¼åˆæ•°æ®['è´¢åŠ¡çŠ¶å†µè¯„åˆ†'] * self.æƒé‡_è´¢åŠ¡çŠ¶å†µ +
            self.ç»¼åˆæ•°æ®['ä¸šåŠ¡ç¨³å®šæ€§è¯„åˆ†'] * self.æƒé‡_ä¸šåŠ¡ç¨³å®š +
            self.ç»¼åˆæ•°æ®['å‘ç¥¨è´¨é‡è¯„åˆ†'] * self.æƒé‡_å‘ç¥¨è´¨é‡
        )
        
        # 2. ç¡®å®šé£é™©ç­‰çº§
        risk_bins = [0, 0.2, 0.4, 0.6, 0.8, 1.0]
        risk_labels = ['æé«˜é£é™©', 'é«˜é£é™©', 'ä¸­é£é™©', 'è¾ƒä½é£é™©', 'ä½é£é™©']
        
        self.ç»¼åˆæ•°æ®['é£é™©ç­‰çº§'] = pd.cut(
            self.ç»¼åˆæ•°æ®['ç»¼åˆé£é™©è¯„åˆ†'],
            bins=risk_bins,
            labels=risk_labels,
            include_lowest=True
        )
        
        print("âœ… é£é™©è¯„ä¼°æ¨¡å‹æ„å»ºå®Œæˆ")
        
        # 3. æ‰“å°é£é™©ç­‰çº§åˆ†å¸ƒ
        é£é™©åˆ†å¸ƒ = self.ç»¼åˆæ•°æ®['é£é™©ç­‰çº§'].value_counts().sort_index()
        print("\nğŸ“Š é£é™©è¯„çº§åˆ†å¸ƒ:")
        for level, count in é£é™©åˆ†å¸ƒ.items():
            percentage = count / len(self.ç»¼åˆæ•°æ®) * 100
            print(f"   {level}: {count}å®¶ ({percentage:.1f}%)")
            
    def design_credit_strategy(self, total_budget=10000):
        """è®¾è®¡ä¿¡è´·ç­–ç•¥"""
        print(f"\nğŸ’° è®¾è®¡ä¿¡è´·ç­–ç•¥ (æ€»é¢„ç®—{total_budget}ä¸‡å…ƒ)...")
        
        # 1. è®¾ç½®åŸºç¡€è´·æ¬¾æ¡ä»¶
        def calculate_credit_limit(row):
            """è®¡ç®—è´·æ¬¾é¢åº¦"""
            risk_score = row['ç»¼åˆé£é™©è¯„åˆ†']
            annual_revenue = row['å¹´æ”¶å…¥']
            
            if risk_score < 0.2:  # æé«˜é£é™©ï¼Œä¸äºˆè´·æ¬¾
                return 0
                
            # åŸºç¡€é¢åº¦ = å¹´æ”¶å…¥ * é£é™©ç³»æ•° * 0.3 (æœ€é«˜å¯è´·å¹´æ”¶å…¥çš„30%)
            base_limit = annual_revenue * risk_score * 0.3
            
            # æ ¹æ®é£é™©ç­‰çº§è®¾ç½®ä¸Šé™
            if risk_score >= 0.8:  # ä½é£é™©
                return min(base_limit, 500)  # æœ€é«˜500ä¸‡
            elif risk_score >= 0.6:  # è¾ƒä½é£é™©
                return min(base_limit, 300)  # æœ€é«˜300ä¸‡
            elif risk_score >= 0.4:  # ä¸­é£é™©
                return min(base_limit, 200)  # æœ€é«˜200ä¸‡
            else:  # é«˜é£é™©
                return min(base_limit, 100)  # æœ€é«˜100ä¸‡
        
        def get_base_rate(risk_score):
            """è·å–åŸºç¡€åˆ©ç‡"""
            if risk_score >= 0.8: return 0.04  # ä½é£é™©
            if risk_score >= 0.6: return 0.06  # è¾ƒä½é£é™©
            if risk_score >= 0.4: return 0.08  # ä¸­é£é™©
            if risk_score >= 0.2: return 0.10  # é«˜é£é™©
            return 0.12  # æé«˜é£é™©
        
        # 2. è®¡ç®—åˆå§‹è´·æ¬¾æ–¹æ¡ˆ
        self.ç»¼åˆæ•°æ®['æ¨èé¢åº¦'] = self.ç»¼åˆæ•°æ®.apply(calculate_credit_limit, axis=1)
        self.ç»¼åˆæ•°æ®['åŸºç¡€åˆ©ç‡'] = self.ç»¼åˆæ•°æ®['ç»¼åˆé£é™©è¯„åˆ†'].apply(get_base_rate)
        
        # 3. ä¼˜åŒ–åˆ©ç‡è®¾ç½®
        self._optimize_interest_rates()
        
        # 4. ä¼˜åŒ–é¢åº¦åˆ†é…
        self._optimize_budget_allocation(total_budget)
        
        print("âœ… ä¿¡è´·ç­–ç•¥è®¾è®¡å®Œæˆ")
        
    def _optimize_interest_rates(self):
        """ä¼˜åŒ–è´·æ¬¾åˆ©ç‡ï¼ˆè€ƒè™‘å®¢æˆ·æµå¤±ç‡ï¼‰"""
        print("\nğŸ¯ ä¼˜åŒ–è´·æ¬¾åˆ©ç‡...")
        
        def get_optimal_rate(row):
            """è·å–æœ€ä¼˜åˆ©ç‡"""
            if row['æ¨èé¢åº¦'] == 0:
                return 0
                
            risk_score = row['ç»¼åˆé£é™©è¯„åˆ†']
            base_rate = row['åŸºç¡€åˆ©ç‡']
            
            # æ„å»ºåˆ©ç‡-æµå¤±ç‡å¯¹åº”å…³ç³»
            rates = np.array([0.04, 0.06, 0.08, 0.10, 0.12, 0.15])
            churn_rates = np.array([0.05, 0.10, 0.15, 0.20, 0.25, 0.30])
            
            # åœ¨åŸºå‡†åˆ©ç‡ä¸Šä¸‹0.02èŒƒå›´å†…å¯»æ‰¾æœ€ä¼˜åˆ©ç‡
            best_rate = base_rate
            best_income = 0
            
            for rate in np.arange(max(0.04, base_rate-0.02), 
                                min(0.15, base_rate+0.02), 0.001):
                # è®¡ç®—è¯¥åˆ©ç‡ä¸‹çš„æµå¤±ç‡
                churn_rate = np.interp(rate, rates, churn_rates)
                # è®¡ç®—é¢„æœŸæ”¶ç›Š
                income = rate * (1 - churn_rate) * (1 - risk_score)
                
                if income > best_income:
                    best_income = income
                    best_rate = rate
                    
            return best_rate
            
        self.ç»¼åˆæ•°æ®['æ¨èåˆ©ç‡'] = self.ç»¼åˆæ•°æ®.apply(get_optimal_rate, axis=1)
        
    def _optimize_budget_allocation(self, total_budget):
        """ä¼˜åŒ–é¢„ç®—åˆ†é…"""
        # 1. è®¡ç®—é¢„æœŸæ”¶ç›Š
        self.ç»¼åˆæ•°æ®['é¢„æœŸæ”¶ç›Šç‡'] = (
            self.ç»¼åˆæ•°æ®['æ¨èåˆ©ç‡'] * 
            (1 - self.ç»¼åˆæ•°æ®['ç»¼åˆé£é™©è¯„åˆ†'])
        )
        
        # 2. æ’åºå¹¶åˆ†é…é¢åº¦
        å€™é€‰ä¼ä¸š = self.ç»¼åˆæ•°æ®[self.ç»¼åˆæ•°æ®['æ¨èé¢åº¦'] > 0].copy()
        å€™é€‰ä¼ä¸š = å€™é€‰ä¼ä¸š.sort_values('é¢„æœŸæ”¶ç›Šç‡', ascending=False)
        
        ç´¯è®¡é¢„ç®— = 0
        æœ€ç»ˆé¢åº¦ = []
        
        for idx, row in å€™é€‰ä¼ä¸š.iterrows():
            if ç´¯è®¡é¢„ç®— + row['æ¨èé¢åº¦'] <= total_budget:
                æœ€ç»ˆé¢åº¦.append(row['æ¨èé¢åº¦'])
                ç´¯è®¡é¢„ç®— += row['æ¨èé¢åº¦']
            elif total_budget - ç´¯è®¡é¢„ç®— >= 10:  # ç¡®ä¿æœ€å°é¢åº¦
                æœ€ç»ˆé¢åº¦.append(total_budget - ç´¯è®¡é¢„ç®—)
                ç´¯è®¡é¢„ç®— = total_budget
            else:
                æœ€ç»ˆé¢åº¦.append(0)
                
        å€™é€‰ä¼ä¸š['æœ€ç»ˆé¢åº¦'] = æœ€ç»ˆé¢åº¦
        
        # 3. æ›´æ–°ä¸»æ•°æ®è¡¨
        self.ç»¼åˆæ•°æ®['æœ€ç»ˆé¢åº¦'] = 0
        self.ç»¼åˆæ•°æ®.loc[å€™é€‰ä¼ä¸š.index, 'æœ€ç»ˆé¢åº¦'] = å€™é€‰ä¼ä¸š['æœ€ç»ˆé¢åº¦']
        
        # 4. æ ‡è®°è´·æ¬¾å†³ç­–
        self.ç»¼åˆæ•°æ®['è´·æ¬¾å†³ç­–'] = self.ç»¼åˆæ•°æ®['æœ€ç»ˆé¢åº¦'].apply(
            lambda x: 'æ‰¹å‡†' if x > 0 else 'æ‹’ç»'
        )
        
    def generate_analysis_report(self):
        """ç”Ÿæˆåˆ†ææŠ¥å‘Š"""
        print("\n" + "="*80)
        print("ğŸ“Š é—®é¢˜2ï¼š302å®¶æ— ä¿¡è´·è®°å½•ä¼ä¸šä¿¡è´·é£é™©é‡åŒ–åˆ†ææŠ¥å‘Š")
        print("="*80)
        
        # 1. é£é™©è¯„ä¼°ç»“æœ
        print("\nğŸ“ˆ é£é™©è¯„ä¼°ç»“æœ:")
        risk_dist = self.ç»¼åˆæ•°æ®['é£é™©ç­‰çº§'].value_counts().sort_index()
        for level, count in risk_dist.items():
            percentage = count / len(self.ç»¼åˆæ•°æ®) * 100
            print(f"   {level}: {count}å®¶ ({percentage:.1f}%)")
            
        # 2. ä¿¡è´·å†³ç­–ç»“æœ
        æ‰¹å‡†ä¼ä¸š = self.ç»¼åˆæ•°æ®[self.ç»¼åˆæ•°æ®['æœ€ç»ˆé¢åº¦'] > 0]
        print(f"\nğŸ’¡ ä¿¡è´·å†³ç­–ç»“æœ:")
        print(f"   æ€»ç”³è¯·ä¼ä¸š: {len(self.ç»¼åˆæ•°æ®)}å®¶")
        print(f"   æ‰¹å‡†è´·æ¬¾: {len(æ‰¹å‡†ä¼ä¸š)}å®¶")
        print(f"   æ‰¹å‡†ç‡: {len(æ‰¹å‡†ä¼ä¸š)/len(self.ç»¼åˆæ•°æ®)*100:.1f}%")
        print(f"   æ€»æ”¾è´·é‡‘é¢: {æ‰¹å‡†ä¼ä¸š['æœ€ç»ˆé¢åº¦'].sum():.0f}ä¸‡å…ƒ")
        print(f"   å¹³å‡é¢åº¦: {æ‰¹å‡†ä¼ä¸š['æœ€ç»ˆé¢åº¦'].mean():.0f}ä¸‡å…ƒ")
        print(f"   å¹³å‡åˆ©ç‡: {æ‰¹å‡†ä¼ä¸š['æ¨èåˆ©ç‡'].mean()*100:.2f}%")
        
        # 3. é£é™©ç­‰çº§åˆ†å¸ƒç»Ÿè®¡
        é£é™©åˆ†å¸ƒ = pd.cut(æ‰¹å‡†ä¼ä¸š['ç»¼åˆé£é™©è¯„åˆ†'], 
                     bins=[0, 0.2, 0.4, 0.6, 0.8, 1],
                     labels=['æé«˜é£é™©', 'é«˜é£é™©', 'ä¸­é£é™©', 'è¾ƒä½é£é™©', 'ä½é£é™©'])
        
        é£é™©ç»Ÿè®¡ = pd.DataFrame({
            'ä¼ä¸šæ•°é‡': é£é™©åˆ†å¸ƒ.value_counts().sort_index(),
            'æ”¾è´·é‡‘é¢': æ‰¹å‡†ä¼ä¸š.groupby(é£é™©åˆ†å¸ƒ)['æœ€ç»ˆé¢åº¦'].sum(),
            'å¹³å‡åˆ©ç‡': æ‰¹å‡†ä¼ä¸š.groupby(é£é™©åˆ†å¸ƒ)['æ¨èåˆ©ç‡'].mean()
        })
        
        print(f"\nğŸ“Š æ‰¹å‡†ä¼ä¸šé£é™©åˆ†å¸ƒ:")
        print(é£é™©ç»Ÿè®¡)
        
        # 4. ç»˜åˆ¶é£é™©åˆ†å¸ƒå›¾
        plt.figure(figsize=(10, 6))
        sns.barplot(x=é£é™©ç»Ÿè®¡.index, y='ä¼ä¸šæ•°é‡', data=é£é™©ç»Ÿè®¡)
        plt.title('æ‰¹å‡†è´·æ¬¾ä¼ä¸šé£é™©åˆ†å¸ƒ')
        plt.xlabel('é£é™©ç­‰çº§')
        plt.ylabel('ä¼ä¸šæ•°é‡')
        plt.xticks(rotation=45)
        plt.tight_layout()
        plt.savefig('é—®é¢˜2_é£é™©åˆ†å¸ƒ.png')
        plt.close()
        
    def export_results(self):
        """å¯¼å‡ºåˆ†æç»“æœ"""
        # 1. é€‰æ‹©è¦å¯¼å‡ºçš„å­—æ®µ
        columns = [
            'ä¼ä¸šä»£å·', 'é£é™©ç­‰çº§', 'ç»¼åˆé£é™©è¯„åˆ†',
            'è´¢åŠ¡çŠ¶å†µè¯„åˆ†', 'ä¸šåŠ¡ç¨³å®šæ€§è¯„åˆ†', 'å‘ç¥¨è´¨é‡è¯„åˆ†',
            'å¹´æ”¶å…¥', 'æ¯›åˆ©ç‡', 'æ”¶å…¥æˆæœ¬æ¯”',
            'å®¢æˆ·æ•°é‡', 'ä¾›åº”å•†æ•°é‡', 'æ•´ä½“ä½œåºŸç‡',
            'æ¨èé¢åº¦', 'æœ€ç»ˆé¢åº¦', 'æ¨èåˆ©ç‡', 'è´·æ¬¾å†³ç­–'
        ]
        
        # 2. å¯¼å‡ºåˆ°Excel
        ç»“æœæ•°æ® = self.ç»¼åˆæ•°æ®[columns].round(4)
        ç»“æœæ•°æ®.to_excel('é—®é¢˜2_ä¿¡è´·é£é™©åˆ†æç»“æœ.xlsx', index=False)
        print(f"\nâœ… åˆ†æç»“æœå·²å¯¼å‡ºè‡³: é—®é¢˜2_ä¿¡è´·é£é™©åˆ†æç»“æœ.xlsx")

def main():
    """ä¸»å‡½æ•°"""
    # 1. åˆ›å»ºåˆ†æå™¨å®ä¾‹
    analyzer = CreditAnalyzer()
    
    # 2. åŠ è½½æ•°æ®
    if not analyzer.load_data():
        return
    
    # 3. ç‰¹å¾åˆ†æ
    analyzer.analyze_invoice_features()
    
    # 4. é£é™©å»ºæ¨¡
    analyzer.build_risk_model()
    
    # 5. åˆ¶å®šç­–ç•¥
    analyzer.design_credit_strategy(total_budget=10000)  # 1äº¿å…ƒé¢„ç®—
    
    # 6. ç”ŸæˆæŠ¥å‘Š
    analyzer.generate_analysis_report()
    
    # 7. å¯¼å‡ºç»“æœ
    analyzer.export_results()
    
    print("\nğŸ‰ é—®é¢˜2åˆ†æå®Œæˆ!")
    print("ğŸ“Š å·²å®Œæˆå¯¹302å®¶æ— ä¿¡è´·è®°å½•ä¼ä¸šçš„é£é™©é‡åŒ–åˆ†æ")
    print("ğŸ’° å·²åœ¨1äº¿å…ƒé¢åº¦å†…åˆ¶å®šæœ€ä¼˜ä¿¡è´·ç­–ç•¥")

if __name__ == "__main__":
    main()
