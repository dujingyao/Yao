#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ä¸­å°å¾®ä¼ä¸šä¿¡è´·ç­–ç•¥åˆ†æ - åŸºäºå†³ç­–ç¤ºä¾‹çš„å…¨é¢åˆ†æ
æ ¹æ®å…¸å‹å†³ç­–ç¤ºä¾‹åˆ¶å®šè¦†ç›–123å®¶ä¼ä¸šçš„ä¿¡è´·ç­–ç•¥

Author: æ•°æ®åˆ†æå›¢é˜Ÿ
Date: 2025å¹´
"""

import pandas as pd
import numpy as np
import os

class ComprehensiveCreditAnalyzer:
    """å…¨é¢ä¿¡è´·ç­–ç•¥åˆ†æå™¨"""
    
    def __init__(self):
        self.ä¼ä¸šä¿¡æ¯ = None
        self.è¿›é¡¹å‘ç¥¨ = None
        self.é”€é¡¹å‘ç¥¨ = None
        self.ç»¼åˆæ•°æ® = None
        self.ä¿¡è´·ç­–ç•¥ = None
        
    def load_data(self):
        """åŠ è½½æ•°æ®"""
        file_path = "é™„ä»¶1ï¼š123å®¶æœ‰ä¿¡è´·è®°å½•ä¼ä¸šçš„ç›¸å…³æ•°æ®.xlsx"
        
        try:
            print(f"ğŸ“ æ­£åœ¨åŠ è½½æ•°æ®æ–‡ä»¶: {file_path}")
            excel_file = pd.ExcelFile(file_path)
            
            self.ä¼ä¸šä¿¡æ¯ = pd.read_excel(excel_file, sheet_name='ä¼ä¸šä¿¡æ¯')
            self.è¿›é¡¹å‘ç¥¨ = pd.read_excel(excel_file, sheet_name='è¿›é¡¹å‘ç¥¨ä¿¡æ¯')
            self.é”€é¡¹å‘ç¥¨ = pd.read_excel(excel_file, sheet_name='é”€é¡¹å‘ç¥¨ä¿¡æ¯')
            
            print(f"âœ… æ•°æ®åŠ è½½æˆåŠŸ!")
            print(f"   ä¼ä¸šä¿¡æ¯: {self.ä¼ä¸šä¿¡æ¯.shape}")
            print(f"   è¿›é¡¹å‘ç¥¨: {self.è¿›é¡¹å‘ç¥¨.shape}")
            print(f"   é”€é¡¹å‘ç¥¨: {self.é”€é¡¹å‘ç¥¨.shape}")
            
            return True
            
        except Exception as e:
            print(f"âŒ æ•°æ®åŠ è½½å¤±è´¥: {e}")
            return False
    
    def analyze_enterprises(self):
        """åˆ†æä¼ä¸šæ•°æ®"""
        print("\nğŸ” å¼€å§‹ä¼ä¸šåˆ†æ...")
        
        # åˆ†æè¿›é¡¹å‘ç¥¨
        è¿›é¡¹æ±‡æ€» = self.è¿›é¡¹å‘ç¥¨.groupby('ä¼ä¸šä»£å·').agg({
            'ä»·ç¨åˆè®¡': ['sum', 'count', 'mean', 'std'],
            'é‡‘é¢': 'sum',
            'ç¨é¢': 'sum',
            'å‘ç¥¨çŠ¶æ€': lambda x: (x == 'ä½œåºŸå‘ç¥¨').sum()
        }).round(2)
        
        è¿›é¡¹æ±‡æ€».columns = ['è¿›é¡¹æ€»é¢', 'è¿›é¡¹å‘ç¥¨æ•°é‡', 'è¿›é¡¹å¹³å‡é‡‘é¢', 'è¿›é¡¹æ ‡å‡†å·®', 'è¿›é¡¹å‡€é‡‘é¢', 'è¿›é¡¹ç¨é¢', 'è¿›é¡¹ä½œåºŸæ•°é‡']
        è¿›é¡¹æ±‡æ€»['è¿›é¡¹ä½œåºŸç‡'] = (è¿›é¡¹æ±‡æ€»['è¿›é¡¹ä½œåºŸæ•°é‡'] / è¿›é¡¹æ±‡æ€»['è¿›é¡¹å‘ç¥¨æ•°é‡']).fillna(0)
        
        # åˆ†æé”€é¡¹å‘ç¥¨
        é”€é¡¹æ±‡æ€» = self.é”€é¡¹å‘ç¥¨.groupby('ä¼ä¸šä»£å·').agg({
            'ä»·ç¨åˆè®¡': ['sum', 'count', 'mean', 'std'],
            'é‡‘é¢': 'sum',
            'ç¨é¢': 'sum',
            'å‘ç¥¨çŠ¶æ€': lambda x: (x.str.strip() == 'ä½œåºŸå‘ç¥¨').sum()
        }).round(2)
        
        é”€é¡¹æ±‡æ€».columns = ['é”€é¡¹æ€»é¢', 'é”€é¡¹å‘ç¥¨æ•°é‡', 'é”€é¡¹å¹³å‡é‡‘é¢', 'é”€é¡¹æ ‡å‡†å·®', 'é”€é¡¹å‡€é‡‘é¢', 'é”€é¡¹ç¨é¢', 'é”€é¡¹ä½œåºŸæ•°é‡']
        é”€é¡¹æ±‡æ€»['é”€é¡¹ä½œåºŸç‡'] = (é”€é¡¹æ±‡æ€»['é”€é¡¹ä½œåºŸæ•°é‡'] / é”€é¡¹æ±‡æ€»['é”€é¡¹å‘ç¥¨æ•°é‡']).fillna(0)
        
        # åˆå¹¶æ‰€æœ‰æ•°æ®
        self.ç»¼åˆæ•°æ® = self.ä¼ä¸šä¿¡æ¯.set_index('ä¼ä¸šä»£å·').join([è¿›é¡¹æ±‡æ€», é”€é¡¹æ±‡æ€»], how='left').fillna(0)
        
        # è®¡ç®—å…³é”®æŒ‡æ ‡
        self._calculate_key_metrics()
        
        print("âœ… ä¼ä¸šåˆ†æå®Œæˆ!")
        return True
    
    def _calculate_key_metrics(self):
        """è®¡ç®—å…³é”®æŒ‡æ ‡"""
        
        # 1. è´¢åŠ¡å¥åº·åº¦æŒ‡æ ‡
        self.ç»¼åˆæ•°æ®['è¥ä¸šæ”¶å…¥'] = self.ç»¼åˆæ•°æ®['é”€é¡¹å‡€é‡‘é¢']
        self.ç»¼åˆæ•°æ®['è¥ä¸šæˆæœ¬'] = self.ç»¼åˆæ•°æ®['è¿›é¡¹å‡€é‡‘é¢']
        self.ç»¼åˆæ•°æ®['æ¯›åˆ©æ¶¦'] = self.ç»¼åˆæ•°æ®['è¥ä¸šæ”¶å…¥'] - self.ç»¼åˆæ•°æ®['è¥ä¸šæˆæœ¬']
        self.ç»¼åˆæ•°æ®['æ¯›åˆ©ç‡'] = (self.ç»¼åˆæ•°æ®['æ¯›åˆ©æ¶¦'] / (self.ç»¼åˆæ•°æ®['è¥ä¸šæ”¶å…¥'] + 1e-8)).clip(-1, 1)
        
        # 2. ç°é‡‘æµæŒ‡æ ‡
        self.ç»¼åˆæ•°æ®['ç°é‡‘æµå…¥'] = self.ç»¼åˆæ•°æ®['é”€é¡¹æ€»é¢']
        self.ç»¼åˆæ•°æ®['ç°é‡‘æµå‡º'] = self.ç»¼åˆæ•°æ®['è¿›é¡¹æ€»é¢']
        self.ç»¼åˆæ•°æ®['å‡€ç°é‡‘æµ'] = self.ç»¼åˆæ•°æ®['ç°é‡‘æµå…¥'] - self.ç»¼åˆæ•°æ®['ç°é‡‘æµå‡º']
        self.ç»¼åˆæ•°æ®['ç°é‡‘æµæ¯”ç‡'] = (self.ç»¼åˆæ•°æ®['ç°é‡‘æµå…¥'] / (self.ç»¼åˆæ•°æ®['ç°é‡‘æµå‡º'] + 1e-8)).clip(0, 10)
        
        # 3. ä¸šåŠ¡æ´»è·ƒåº¦
        self.ç»¼åˆæ•°æ®['æ€»å‘ç¥¨æ•°é‡'] = self.ç»¼åˆæ•°æ®['è¿›é¡¹å‘ç¥¨æ•°é‡'] + self.ç»¼åˆæ•°æ®['é”€é¡¹å‘ç¥¨æ•°é‡']
        self.ç»¼åˆæ•°æ®['ä¸šåŠ¡æ´»è·ƒåº¦è¯„åˆ†'] = np.log1p(self.ç»¼åˆæ•°æ®['æ€»å‘ç¥¨æ•°é‡'])
        
        # 4. å‘ç¥¨è´¨é‡è¯„åˆ†
        self.ç»¼åˆæ•°æ®['æ€»ä½œåºŸæ•°é‡'] = self.ç»¼åˆæ•°æ®['è¿›é¡¹ä½œåºŸæ•°é‡'] + self.ç»¼åˆæ•°æ®['é”€é¡¹ä½œåºŸæ•°é‡']
        self.ç»¼åˆæ•°æ®['æ•´ä½“ä½œåºŸç‡'] = (self.ç»¼åˆæ•°æ®['æ€»ä½œåºŸæ•°é‡'] / (self.ç»¼åˆæ•°æ®['æ€»å‘ç¥¨æ•°é‡'] + 1e-8)).clip(0, 1)
        
        # 5. ä¸šåŠ¡è§„æ¨¡è¯„åˆ†
        self.ç»¼åˆæ•°æ®['ä¸šåŠ¡è§„æ¨¡è¯„åˆ†'] = np.log1p(self.ç»¼åˆæ•°æ®['è¥ä¸šæ”¶å…¥'])
        
        # 6. ä¿¡èª‰è¯„çº§æ•°å€¼åŒ–
        rating_map = {'A': 4, 'B': 3, 'C': 2, 'D': 1}
        self.ç»¼åˆæ•°æ®['ä¿¡èª‰è¯„çº§æ•°å€¼'] = self.ç»¼åˆæ•°æ®['ä¿¡èª‰è¯„çº§'].map(rating_map)
        
        # 7. è¿çº¦æ ‡è¯†
        self.ç»¼åˆæ•°æ®['å†å²è¿çº¦'] = (self.ç»¼åˆæ•°æ®['æ˜¯å¦è¿çº¦'] == 'æ˜¯').astype(int)
    
    def calculate_comprehensive_risk_score(self):
        """è®¡ç®—ç»¼åˆé£é™©è¯„åˆ†"""
        print("âš ï¸ è®¡ç®—ç»¼åˆé£é™©è¯„åˆ†...")
        
        # å„é¡¹é£é™©æƒé‡ï¼ˆå‚è€ƒå…¸å‹å†³ç­–ç¤ºä¾‹ï¼‰
        risk_factors = {
            'ä¿¡èª‰è¯„çº§é£é™©': 0.35,    # 35% - æœ€é‡è¦
            'å†å²è¿çº¦é£é™©': 0.25,    # 25% - å†å²è¡¨ç°
            'è´¢åŠ¡çŠ¶å†µé£é™©': 0.20,    # 20% - è´¢åŠ¡å¥åº·åº¦
            'å‘ç¥¨è´¨é‡é£é™©': 0.15,    # 15% - ä¸šåŠ¡è§„èŒƒæ€§
            'ä¸šåŠ¡ç¨³å®šé£é™©': 0.05     # 5% - ä¸šåŠ¡æ³¢åŠ¨æ€§
        }
        
        # 1. ä¿¡èª‰è¯„çº§é£é™© (35%)
        ä¿¡èª‰é£é™© = {'A': 0.1, 'B': 0.3, 'C': 0.6, 'D': 0.9}
        ä¿¡èª‰è¯„çº§é£é™©å¾—åˆ† = self.ç»¼åˆæ•°æ®['ä¿¡èª‰è¯„çº§'].map(ä¿¡èª‰é£é™©)
        
        # 2. å†å²è¿çº¦é£é™© (25%)
        å†å²è¿çº¦é£é™©å¾—åˆ† = self.ç»¼åˆæ•°æ®['å†å²è¿çº¦'] * 0.8 + (1 - self.ç»¼åˆæ•°æ®['å†å²è¿çº¦']) * 0.1
        
        # 3. è´¢åŠ¡çŠ¶å†µé£é™© (20%)
        # æ¯›åˆ©ç‡è¶Šä½é£é™©è¶Šé«˜
        æ¯›åˆ©ç‡_æ ‡å‡†åŒ– = (self.ç»¼åˆæ•°æ®['æ¯›åˆ©ç‡'] - self.ç»¼åˆæ•°æ®['æ¯›åˆ©ç‡'].min()) / (self.ç»¼åˆæ•°æ®['æ¯›åˆ©ç‡'].max() - self.ç»¼åˆæ•°æ®['æ¯›åˆ©ç‡'].min() + 1e-8)
        è´¢åŠ¡çŠ¶å†µé£é™©å¾—åˆ† = 1 - æ¯›åˆ©ç‡_æ ‡å‡†åŒ–.fillna(0.5)  # åå‘ï¼Œæ¯›åˆ©ç‡é«˜=é£é™©ä½
        
        # 4. å‘ç¥¨è´¨é‡é£é™© (15%)
        # ä½œåºŸç‡è¶Šé«˜é£é™©è¶Šé«˜
        å‘ç¥¨è´¨é‡é£é™©å¾—åˆ† = self.ç»¼åˆæ•°æ®['æ•´ä½“ä½œåºŸç‡']
        
        # 5. ä¸šåŠ¡ç¨³å®šé£é™© (5%)
        # ä¸šåŠ¡æ´»è·ƒåº¦ä½=é£é™©é«˜
        æ´»è·ƒåº¦_æ ‡å‡†åŒ– = (self.ç»¼åˆæ•°æ®['ä¸šåŠ¡æ´»è·ƒåº¦è¯„åˆ†'] - self.ç»¼åˆæ•°æ®['ä¸šåŠ¡æ´»è·ƒåº¦è¯„åˆ†'].min()) / (self.ç»¼åˆæ•°æ®['ä¸šåŠ¡æ´»è·ƒåº¦è¯„åˆ†'].max() - self.ç»¼åˆæ•°æ®['ä¸šåŠ¡æ´»è·ƒåº¦è¯„åˆ†'].min() + 1e-8)
        ä¸šåŠ¡ç¨³å®šé£é™©å¾—åˆ† = 1 - æ´»è·ƒåº¦_æ ‡å‡†åŒ–.fillna(0.5)
        
        # ç»¼åˆé£é™©è¯„åˆ†
        self.ç»¼åˆæ•°æ®['ç»¼åˆé£é™©è¯„åˆ†'] = (
            risk_factors['ä¿¡èª‰è¯„çº§é£é™©'] * ä¿¡èª‰è¯„çº§é£é™©å¾—åˆ† +
            risk_factors['å†å²è¿çº¦é£é™©'] * å†å²è¿çº¦é£é™©å¾—åˆ† +
            risk_factors['è´¢åŠ¡çŠ¶å†µé£é™©'] * è´¢åŠ¡çŠ¶å†µé£é™©å¾—åˆ† +
            risk_factors['å‘ç¥¨è´¨é‡é£é™©'] * å‘ç¥¨è´¨é‡é£é™©å¾—åˆ† +
            risk_factors['ä¸šåŠ¡ç¨³å®šé£é™©'] * ä¸šåŠ¡ç¨³å®šé£é™©å¾—åˆ†
        ).clip(0, 1)
        
        # é£é™©ç­‰çº§åˆ†ç±»
        def classify_risk(score):
            if score <= 0.3:
                return 'ä½é£é™©'
            elif score <= 0.5:
                return 'ä¸­ä½é£é™©'
            elif score <= 0.7:
                return 'ä¸­é«˜é£é™©'
            else:
                return 'é«˜é£é™©'
        
        self.ç»¼åˆæ•°æ®['é£é™©ç­‰çº§'] = self.ç»¼åˆæ•°æ®['ç»¼åˆé£é™©è¯„åˆ†'].apply(classify_risk)
        
        print("âœ… ç»¼åˆé£é™©è¯„åˆ†è®¡ç®—å®Œæˆ!")
    
    def develop_credit_strategy(self, total_budget=10000):
        """åˆ¶å®šä¿¡è´·ç­–ç•¥ï¼ˆè¦†ç›–æ‰€æœ‰123å®¶ä¼ä¸šï¼‰"""
        print(f"\nğŸ¯ åˆ¶å®šå…¨é¢ä¿¡è´·ç­–ç•¥ï¼Œæ€»é¢„ç®—: {total_budget}ä¸‡å…ƒ")
        
        # å¤åˆ¶æ•°æ®ç”¨äºç­–ç•¥åˆ¶å®š
        strategy_data = self.ç»¼åˆæ•°æ®.copy().reset_index()
        
        # åŸºäºå…¸å‹å†³ç­–ç¤ºä¾‹çš„ç­–ç•¥æ¡†æ¶
        strategy_results = []
        
        for idx, row in strategy_data.iterrows():
            ä¼ä¸šä»£å· = row['ä¼ä¸šä»£å·']
            ä¿¡èª‰è¯„çº§ = row['ä¿¡èª‰è¯„çº§']
            å†å²è¿çº¦ = row['å†å²è¿çº¦']
            é£é™©è¯„åˆ† = row['ç»¼åˆé£é™©è¯„åˆ†']
            
            # å†³ç­–é€»è¾‘ï¼ˆåŸºäºæä¾›çš„å…¸å‹ç¤ºä¾‹ï¼‰
            decision = self._make_credit_decision(ä¿¡èª‰è¯„çº§, å†å²è¿çº¦, é£é™©è¯„åˆ†, row)
            
            strategy_results.append({
                'ä¼ä¸šä»£å·': ä¼ä¸šä»£å·,
                'ä¼ä¸šåç§°': row['ä¼ä¸šåç§°'],
                'ä¿¡èª‰è¯„çº§': ä¿¡èª‰è¯„çº§,
                'æ˜¯å¦è¿çº¦': 'æ˜¯' if å†å²è¿çº¦ else 'å¦',
                'ç»¼åˆé£é™©è¯„åˆ†': é£é™©è¯„åˆ†,
                'é£é™©ç­‰çº§': row['é£é™©ç­‰çº§'],
                'è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)': decision['è´·æ¬¾é¢åº¦'],
                'åˆ©ç‡': decision['åˆ©ç‡'],
                'å†³ç­–ä¾æ®': decision['å†³ç­–ä¾æ®'],
                'ä¸šåŠ¡æ´»è·ƒåº¦è¯„åˆ†': row['ä¸šåŠ¡æ´»è·ƒåº¦è¯„åˆ†'],
                'æ¯›åˆ©ç‡': row['æ¯›åˆ©ç‡'],
                'æ•´ä½“ä½œåºŸç‡': row['æ•´ä½“ä½œåºŸç‡'],
                'è¥ä¸šæ”¶å…¥': row['è¥ä¸šæ”¶å…¥'],
                'å‡€ç°é‡‘æµ': row['å‡€ç°é‡‘æµ']
            })
        
        # è½¬æ¢ä¸ºDataFrame
        self.ä¿¡è´·ç­–ç•¥ = pd.DataFrame(strategy_results)
        
        # è°ƒæ•´è´·æ¬¾é¢åº¦ä»¥ç¬¦åˆæ€»é¢„ç®—
        self._adjust_loan_amounts(total_budget)
        
        print(f"âœ… ä¿¡è´·ç­–ç•¥åˆ¶å®šå®Œæˆ!")
        print(f"   è¦†ç›–ä¼ä¸šæ•°é‡: {len(self.ä¿¡è´·ç­–ç•¥)}å®¶")
        print(f"   è·è´·ä¼ä¸šæ•°é‡: {len(self.ä¿¡è´·ç­–ç•¥[self.ä¿¡è´·ç­–ç•¥['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'] > 0])}å®¶")
        
        return self.ä¿¡è´·ç­–ç•¥
    
    def _make_credit_decision(self, ä¿¡èª‰è¯„çº§, å†å²è¿çº¦, é£é™©è¯„åˆ†, enterprise_data):
        """åŸºäºå…¸å‹å†³ç­–ç¤ºä¾‹åˆ¶å®šå•ä¸ªä¼ä¸šçš„ä¿¡è´·å†³ç­–"""
        
        # åŸºç¡€å†³ç­–æ¡†æ¶
        if ä¿¡èª‰è¯„çº§ == 'A':
            if not å†å²è¿çº¦:
                # Açº§æ— è¿çº¦ï¼šä½é£é™©é«˜é¢åº¦
                è´·æ¬¾é¢åº¦ = min(200, max(50, enterprise_data['è¥ä¸šæ”¶å…¥'] * 0.3))
                åˆ©ç‡ = 0.045 + 0.02 * é£é™©è¯„åˆ†  # 4.5%-6.5%
                å†³ç­–ä¾æ® = "ä½é£é™©é«˜é¢åº¦"
            else:
                # Açº§æœ‰è¿çº¦ï¼šè°¨æ…æ”¾è´·
                è´·æ¬¾é¢åº¦ = min(100, max(30, enterprise_data['è¥ä¸šæ”¶å…¥'] * 0.2))
                åˆ©ç‡ = 0.055 + 0.03 * é£é™©è¯„åˆ†  # 5.5%-8.5%
                å†³ç­–ä¾æ® = "Açº§è¿çº¦ä¼ä¸šè°¨æ…æ”¾è´·"
                
        elif ä¿¡èª‰è¯„çº§ == 'B':
            if not å†å²è¿çº¦:
                # Bçº§æ— è¿çº¦ï¼šä¸­ç­‰é£é™©ä¸­ç­‰é¢åº¦
                è´·æ¬¾é¢åº¦ = min(150, max(40, enterprise_data['è¥ä¸šæ”¶å…¥'] * 0.25))
                åˆ©ç‡ = 0.055 + 0.03 * é£é™©è¯„åˆ†  # 5.5%-8.5%
                å†³ç­–ä¾æ® = "ä¸­ç­‰é£é™©ä¸­ç­‰é¢åº¦"
            else:
                # Bçº§æœ‰è¿çº¦ï¼šé™ä½é¢åº¦æé«˜åˆ©ç‡
                è´·æ¬¾é¢åº¦ = min(80, max(20, enterprise_data['è¥ä¸šæ”¶å…¥'] * 0.15))
                åˆ©ç‡ = 0.070 + 0.04 * é£é™©è¯„åˆ†  # 7%-11%
                å†³ç­–ä¾æ® = "Bçº§è¿çº¦ä¼ä¸šé™é¢æç‡"
                
        elif ä¿¡èª‰è¯„çº§ == 'C':
            if not å†å²è¿çº¦:
                # Cçº§æ— è¿çº¦ï¼šé«˜é£é™©ä½é¢åº¦é«˜åˆ©ç‡
                è´·æ¬¾é¢åº¦ = min(80, max(15, enterprise_data['è¥ä¸šæ”¶å…¥'] * 0.15))
                åˆ©ç‡ = 0.080 + 0.05 * é£é™©è¯„åˆ†  # 8%-13%
                å†³ç­–ä¾æ® = "é«˜é£é™©ä½é¢åº¦é«˜åˆ©ç‡"
            else:
                # Cçº§æœ‰è¿çº¦ï¼šä¸¥æ ¼é™åˆ¶
                è´·æ¬¾é¢åº¦ = min(30, max(10, enterprise_data['è¥ä¸šæ”¶å…¥'] * 0.1))
                åˆ©ç‡ = 0.100 + 0.05 * é£é™©è¯„åˆ†  # 10%-15%
                å†³ç­–ä¾æ® = "Cçº§è¿çº¦ä¼ä¸šä¸¥æ ¼é™åˆ¶"
                
        else:  # Dçº§
            # Dçº§ä¼ä¸šï¼šåŸåˆ™ä¸Šç¦æ­¢æ”¾è´·
            è´·æ¬¾é¢åº¦ = 0
            åˆ©ç‡ = 0
            å†³ç­–ä¾æ® = "ç¦æ­¢æ”¾è´·"
        
        # ç‰¹æ®Šè°ƒæ•´ï¼šåŸºäºè´¢åŠ¡çŠ¶å†µå¾®è°ƒ
        if è´·æ¬¾é¢åº¦ > 0:
            # è´¢åŠ¡çŠ¶å†µå¥½çš„ä¼ä¸šå¯ä»¥é€‚å½“å¢åŠ é¢åº¦
            if enterprise_data['æ¯›åˆ©ç‡'] > 0.3 and enterprise_data['å‡€ç°é‡‘æµ'] > 0:
                è´·æ¬¾é¢åº¦ *= 1.2
                å†³ç­–ä¾æ® += "+è´¢åŠ¡ä¼˜è‰¯"
            
            # å‘ç¥¨è´¨é‡å·®çš„ä¼ä¸šå‡å°‘é¢åº¦
            if enterprise_data['æ•´ä½“ä½œåºŸç‡'] > 0.15:
                è´·æ¬¾é¢åº¦ *= 0.8
                åˆ©ç‡ += 0.01
                å†³ç­–ä¾æ® += "+å‘ç¥¨è´¨é‡å·®"
        
        # ç¡®ä¿åˆ©ç‡åœ¨åˆç†èŒƒå›´å†…
        åˆ©ç‡ = max(0.04, min(0.18, åˆ©ç‡))
        
        return {
            'è´·æ¬¾é¢åº¦': round(è´·æ¬¾é¢åº¦, 1),
            'åˆ©ç‡': åˆ©ç‡,
            'å†³ç­–ä¾æ®': å†³ç­–ä¾æ®
        }
    
    def _adjust_loan_amounts(self, total_budget):
        """è°ƒæ•´è´·æ¬¾é¢åº¦ä»¥ç¬¦åˆæ€»é¢„ç®—"""
        
        # è®¡ç®—å½“å‰æ€»é¢åº¦
        current_total = self.ä¿¡è´·ç­–ç•¥[self.ä¿¡è´·ç­–ç•¥['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'] > 0]['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'].sum()
        
        if current_total > total_budget:
            # å¦‚æœè¶…é¢„ç®—ï¼ŒæŒ‰æ¯”ä¾‹ç¼©å‡
            adjustment_factor = total_budget / current_total
            mask = self.ä¿¡è´·ç­–ç•¥['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'] > 0
            self.ä¿¡è´·ç­–ç•¥.loc[mask, 'è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'] *= adjustment_factor
            
            print(f"âš–ï¸ é¢„ç®—è°ƒæ•´: æ€»é¢åº¦ä»{current_total:.1f}ä¸‡å…ƒè°ƒæ•´ä¸º{total_budget}ä¸‡å…ƒ")
        
        # å››èˆäº”å…¥
        self.ä¿¡è´·ç­–ç•¥['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'] = self.ä¿¡è´·ç­–ç•¥['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'].round(1)
    
    def generate_comprehensive_report(self):
        """ç”Ÿæˆå…¨é¢çš„åˆ†ææŠ¥å‘Š"""
        
        print("\n" + "="*100)
        print("ğŸ“Š ä¸­å°å¾®ä¼ä¸šä¿¡è´·ç­–ç•¥å…¨é¢åˆ†ææŠ¥å‘Š")
        print("="*100)
        
        # ä¸€ã€æ€»ä½“æ¦‚å†µ
        print(f"\nğŸ“‹ ä¸€ã€æ€»ä½“æ¦‚å†µ")
        print(f"   åˆ†æä¼ä¸šæ€»æ•°: {len(self.ç»¼åˆæ•°æ®)}å®¶")
        print(f"   ä¿¡è´·ç­–ç•¥è¦†ç›–: {len(self.ä¿¡è´·ç­–ç•¥)}å®¶")
        
        è·è´·ä¼ä¸š = self.ä¿¡è´·ç­–ç•¥[self.ä¿¡è´·ç­–ç•¥['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'] > 0]
        æ‹’è´·ä¼ä¸š = self.ä¿¡è´·ç­–ç•¥[self.ä¿¡è´·ç­–ç•¥['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'] == 0]
        
        print(f"   è·å¾—è´·æ¬¾ä¼ä¸š: {len(è·è´·ä¼ä¸š)}å®¶ ({len(è·è´·ä¼ä¸š)/len(self.ä¿¡è´·ç­–ç•¥)*100:.1f}%)")
        print(f"   æ‹’ç»æ”¾è´·ä¼ä¸š: {len(æ‹’è´·ä¼ä¸š)}å®¶ ({len(æ‹’è´·ä¼ä¸š)/len(self.ä¿¡è´·ç­–ç•¥)*100:.1f}%)")
        
        # äºŒã€ä¿¡èª‰è¯„çº§åˆ†æ
        print(f"\nâ­ äºŒã€ä¿¡èª‰è¯„çº§åˆ†å¸ƒä¸ç­–ç•¥")
        rating_analysis = self.ä¿¡è´·ç­–ç•¥.groupby('ä¿¡èª‰è¯„çº§').agg({
            'ä¼ä¸šä»£å·': 'count',
            'è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)': ['sum', 'mean', 'count']
        }).round(2)
        
        rating_analysis.columns = ['ä¼ä¸šæ•°é‡', 'æ€»è´·æ¬¾é¢åº¦', 'å¹³å‡è´·æ¬¾é¢åº¦', 'è·è´·æ•°é‡']
        rating_analysis['è·è´·æ¯”ä¾‹'] = (rating_analysis['è·è´·æ•°é‡'] / rating_analysis['ä¼ä¸šæ•°é‡'] * 100).round(1)
        
        for rating, stats in rating_analysis.iterrows():
            print(f"   {rating}çº§: {stats['ä¼ä¸šæ•°é‡']}å®¶ä¼ä¸š, "
                  f"è·è´·{stats['è·è´·æ•°é‡']}å®¶({stats['è·è´·æ¯”ä¾‹']:.1f}%), "
                  f"æ€»é¢åº¦{stats['æ€»è´·æ¬¾é¢åº¦']:.1f}ä¸‡å…ƒ")
        
        # ä¸‰ã€é£é™©ç­‰çº§åˆ†æ
        print(f"\nâš ï¸ ä¸‰ã€é£é™©ç­‰çº§åˆ†å¸ƒ")
        risk_analysis = self.ä¿¡è´·ç­–ç•¥.groupby('é£é™©ç­‰çº§').agg({
            'ä¼ä¸šä»£å·': 'count',
            'è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)': 'sum'
        }).round(1)
        
        for risk_level, stats in risk_analysis.iterrows():
            pct = stats['ä¼ä¸šä»£å·'] / len(self.ä¿¡è´·ç­–ç•¥) * 100
            print(f"   {risk_level}: {stats['ä¼ä¸šä»£å·']}å®¶({pct:.1f}%), "
                  f"è´·æ¬¾é¢åº¦{stats['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)']}ä¸‡å…ƒ")
        
        # å››ã€è´¢åŠ¡å¥åº·åº¦åˆ†æ
        print(f"\nğŸ’° å››ã€è´¢åŠ¡å¥åº·åº¦åˆ†æ")
        if len(è·è´·ä¼ä¸š) > 0:
            print(f"   è·è´·ä¼ä¸šå¹³å‡æ¯›åˆ©ç‡: {è·è´·ä¼ä¸š['æ¯›åˆ©ç‡'].mean()*100:.2f}%")
            print(f"   è·è´·ä¼ä¸šå¹³å‡è¥ä¸šæ”¶å…¥: {è·è´·ä¼ä¸š['è¥ä¸šæ”¶å…¥'].mean():,.0f}å…ƒ")
            print(f"   è·è´·ä¼ä¸šå¹³å‡å‡€ç°é‡‘æµ: {è·è´·ä¼ä¸š['å‡€ç°é‡‘æµ'].mean():,.0f}å…ƒ")
            print(f"   è·è´·ä¼ä¸šå¹³å‡ä½œåºŸç‡: {è·è´·ä¼ä¸š['æ•´ä½“ä½œåºŸç‡'].mean()*100:.2f}%")
        
        # äº”ã€è´·æ¬¾ç­–ç•¥ç»Ÿè®¡
        print(f"\nğŸ“ˆ äº”ã€è´·æ¬¾ç­–ç•¥ç»Ÿè®¡")
        if len(è·è´·ä¼ä¸š) > 0:
            total_loans = è·è´·ä¼ä¸š['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'].sum()
            avg_loan = è·è´·ä¼ä¸š['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'].mean()
            avg_rate = np.average(è·è´·ä¼ä¸š['åˆ©ç‡'], weights=è·è´·ä¼ä¸š['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'])
            
            print(f"   æ€»æ”¾è´·é‡‘é¢: {total_loans:,.1f}ä¸‡å…ƒ")
            print(f"   å¹³å‡å•ç¬”è´·æ¬¾: {avg_loan:.1f}ä¸‡å…ƒ")
            print(f"   åŠ æƒå¹³å‡åˆ©ç‡: {avg_rate:.2%}")
            print(f"   æœ€å¤§å•ç¬”è´·æ¬¾: {è·è´·ä¼ä¸š['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'].max():.1f}ä¸‡å…ƒ")
            print(f"   æœ€å°å•ç¬”è´·æ¬¾: {è·è´·ä¼ä¸š[è·è´·ä¼ä¸š['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'] > 0]['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'].min():.1f}ä¸‡å…ƒ")
        
        # å…­ã€é£é™©æ§åˆ¶æªæ–½
        print(f"\nğŸ›¡ï¸ å…­ã€é£é™©æ§åˆ¶æªæ–½")
        
        # é«˜é£é™©ä¼ä¸šç»Ÿè®¡
        high_risk_loans = è·è´·ä¼ä¸š[è·è´·ä¼ä¸š['é£é™©ç­‰çº§'].isin(['ä¸­é«˜é£é™©', 'é«˜é£é™©'])]
        if len(high_risk_loans) > 0:
            high_risk_amount = high_risk_loans['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'].sum()
            high_risk_ratio = high_risk_amount / è·è´·ä¼ä¸š['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'].sum()
            print(f"   é«˜é£é™©è´·æ¬¾: {len(high_risk_loans)}ç¬”, "
                  f"é‡‘é¢{high_risk_amount:.1f}ä¸‡å…ƒ({high_risk_ratio:.1%})")
        
        # è¿çº¦ä¼ä¸šç»Ÿè®¡
        default_loans = è·è´·ä¼ä¸š[è·è´·ä¼ä¸š['æ˜¯å¦è¿çº¦'] == 'æ˜¯']
        if len(default_loans) > 0:
            default_amount = default_loans['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'].sum()
            print(f"   è¿çº¦ä¼ä¸šè´·æ¬¾: {len(default_loans)}ç¬”, "
                  f"é‡‘é¢{default_amount:.1f}ä¸‡å…ƒ")
        
        # ä¸ƒã€å†³ç­–ä¾æ®ç»Ÿè®¡
        print(f"\nğŸ“Š ä¸ƒã€å†³ç­–ä¾æ®åˆ†å¸ƒ")
        decision_stats = self.ä¿¡è´·ç­–ç•¥['å†³ç­–ä¾æ®'].value_counts()
        for decision, count in decision_stats.head(10).items():
            pct = count / len(self.ä¿¡è´·ç­–ç•¥) * 100
            print(f"   {decision}: {count}å®¶({pct:.1f}%)")
        
        # å…«ã€å…¸å‹æ¡ˆä¾‹å±•ç¤º
        print(f"\nğŸ† å…«ã€å…¸å‹æ¡ˆä¾‹å±•ç¤ºï¼ˆå‰10å¤§è´·æ¬¾ä¼ä¸šï¼‰")
        top_enterprises = è·è´·ä¼ä¸š.nlargest(10, 'è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)')
        
        print(f"{'åºå·':<4} {'ä¼ä¸šä»£å·':<8} {'ä¿¡èª‰è¯„çº§':<6} {'è¿çº¦':<4} {'é¢åº¦(ä¸‡å…ƒ)':<10} {'åˆ©ç‡':<6} {'å†³ç­–ä¾æ®':<20}")
        print("-" * 80)
        
        for idx, (_, row) in enumerate(top_enterprises.iterrows(), 1):
            print(f"{idx:<4} {row['ä¼ä¸šä»£å·']:<8} {row['ä¿¡èª‰è¯„çº§']:<6} "
                  f"{row['æ˜¯å¦è¿çº¦']:<4} {row['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)']:<10.1f} "
                  f"{row['åˆ©ç‡']:<6.2%} {row['å†³ç­–ä¾æ®']:<20}")
        
        print(f"\n" + "="*100)
        print(f"ğŸ“‹ æŠ¥å‘Šç”Ÿæˆå®Œæˆ - æ¶µç›–å…¨éƒ¨123å®¶ä¼ä¸šçš„ä¿¡è´·ç­–ç•¥")
        print(f"="*100)
    
    def export_results(self):
        """å¯¼å‡ºåˆ†æç»“æœ"""
        try:
            # å¯¼å‡ºç»¼åˆä¼ä¸šæ•°æ®
            self.ç»¼åˆæ•°æ®.reset_index().to_excel('ä¼ä¸šå…¨é¢åˆ†ææ•°æ®.xlsx', index=False)
            print(f"ğŸ’¾ ä¼ä¸šå…¨é¢åˆ†ææ•°æ®å·²ä¿å­˜è‡³: ä¼ä¸šå…¨é¢åˆ†ææ•°æ®.xlsx")
            
            # å¯¼å‡ºä¿¡è´·ç­–ç•¥ï¼ˆ123å®¶ä¼ä¸šå®Œæ•´ç‰ˆï¼‰
            if self.ä¿¡è´·ç­–ç•¥ is not None:
                self.ä¿¡è´·ç­–ç•¥.to_excel('ä¿¡è´·ç­–ç•¥å®Œæ•´ç‰ˆ_123å®¶ä¼ä¸š.xlsx', index=False)
                print(f"ğŸ’¾ å®Œæ•´ä¿¡è´·ç­–ç•¥å·²ä¿å­˜è‡³: ä¿¡è´·ç­–ç•¥å®Œæ•´ç‰ˆ_123å®¶ä¼ä¸š.xlsx")
                
                # å•ç‹¬å¯¼å‡ºè·è´·ä¼ä¸šæ¸…å•
                è·è´·ä¼ä¸š = self.ä¿¡è´·ç­–ç•¥[self.ä¿¡è´·ç­–ç•¥['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'] > 0]
                è·è´·ä¼ä¸š.to_excel('è·è´·ä¼ä¸šæ¸…å•.xlsx', index=False)
                print(f"ğŸ’¾ è·è´·ä¼ä¸šæ¸…å•å·²ä¿å­˜è‡³: è·è´·ä¼ä¸šæ¸…å•.xlsx")
                
                # å•ç‹¬å¯¼å‡ºæ‹’è´·ä¼ä¸šæ¸…å•
                æ‹’è´·ä¼ä¸š = self.ä¿¡è´·ç­–ç•¥[self.ä¿¡è´·ç­–ç•¥['è´·æ¬¾é¢åº¦(ä¸‡å…ƒ)'] == 0]
                æ‹’è´·ä¼ä¸š.to_excel('æ‹’è´·ä¼ä¸šæ¸…å•.xlsx', index=False)
                print(f"ğŸ’¾ æ‹’è´·ä¼ä¸šæ¸…å•å·²ä¿å­˜è‡³: æ‹’è´·ä¼ä¸šæ¸…å•.xlsx")
            
            return True
            
        except Exception as e:
            print(f"âŒ å¯¼å‡ºå¤±è´¥: {e}")
            return False

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸ¦ ä¸­å°å¾®ä¼ä¸šä¿¡è´·ç­–ç•¥å…¨é¢åˆ†æç³»ç»Ÿ")
    print("åŸºäºå…¸å‹å†³ç­–ç¤ºä¾‹çš„123å®¶ä¼ä¸šå®Œæ•´ä¿¡è´·ç­–ç•¥")
    print("=" * 80)
    
    # åˆ›å»ºåˆ†æå™¨
    analyzer = ComprehensiveCreditAnalyzer()
    
    try:
        # 1. åŠ è½½æ•°æ®
        if not analyzer.load_data():
            return
        
        # 2. åˆ†æä¼ä¸š
        if not analyzer.analyze_enterprises():
            return
        
        # 3. è®¡ç®—é£é™©è¯„åˆ†
        analyzer.calculate_comprehensive_risk_score()
        
        # 4. åˆ¶å®šä¿¡è´·ç­–ç•¥ï¼ˆè¦†ç›–å…¨éƒ¨123å®¶ä¼ä¸šï¼‰
        strategy = analyzer.develop_credit_strategy(total_budget=10000)  # æ€»é¢„ç®—1äº¿å…ƒ
        
        # 5. ç”Ÿæˆå…¨é¢æŠ¥å‘Š
        analyzer.generate_comprehensive_report()
        
        # 6. å¯¼å‡ºç»“æœ
        analyzer.export_results()
        
        print(f"\nğŸ‰ å…¨é¢åˆ†æå®Œæˆ!")
        print(f"âœ… å·²ç”Ÿæˆè¦†ç›–å…¨éƒ¨123å®¶ä¼ä¸šçš„ä¿¡è´·ç­–ç•¥")
        print(f"ğŸ“„ è¯·æŸ¥çœ‹å¯¼å‡ºçš„Excelæ–‡ä»¶è·å–è¯¦ç»†ä¿¡æ¯")
        
    except Exception as e:
        print(f"âŒ ç¨‹åºæ‰§è¡Œå‡ºé”™: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()
